**# åŸºäºäº’ä¿¡æ¯çš„é‡åŒ–åˆ†ç»„ - é¡¹ç›®æ€»ç»“

## ğŸ“ é¡¹ç›®ç»“æ„

```
mutual_info_quantization/
â”œâ”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ æ”¹è¿›æ–¹æ¡ˆè¯„ä¼°.md              # å¯è¡Œæ€§è¯„ä¼°ï¼ˆâ­ æ¨èå…ˆè¯»ï¼‰
â”œâ”€â”€ é¡¹ç›®æ€»ç»“.md                  # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ mutual_info.py               # äº’ä¿¡æ¯è®¡ç®—æ¨¡å—
â”œâ”€â”€ channel_grouping.py          # é€šé“åˆ†ç»„ç®—æ³•
â”œâ”€â”€ sparsegpt_mi.py              # MIé‡åŒ–SparseGPTå®ç°
â”œâ”€â”€ opt_mi.py                    # OPTæ¨¡å‹æµ‹è¯•è„šæœ¬
â”‚
â”œâ”€â”€ test_mi.sh                   # å¿«é€Ÿæµ‹è¯•è„šæœ¬
â””â”€â”€ test_results/                # æµ‹è¯•ç»“æœç›®å½•ï¼ˆè¿è¡Œåç”Ÿæˆï¼‰
```

---

## ğŸ¯ æ ¸å¿ƒæ€æƒ³

### é—®é¢˜

**å½“å‰å¢å¼ºç‰ˆçš„å±€é™**ï¼š
- æ¯ä¸ªé€šé“ç‹¬ç«‹é‡åŒ–
- æœªè€ƒè™‘é€šé“é—´çš„ç›¸å…³æ€§å’Œå†—ä½™
- åœ¨æŸäº›å±‚ä¸­å­˜åœ¨å¤§é‡å†—ä½™é€šé“

### è§£å†³æ–¹æ¡ˆ

**äº’ä¿¡æ¯åˆ†ç»„é‡åŒ–**ï¼š
1. **è®¡ç®—äº’ä¿¡æ¯**: é‡åŒ–é€šé“é—´çš„ä¾èµ–å…³ç³»
2. **æ™ºèƒ½åˆ†ç»„**: å°†ç›¸å…³/å†—ä½™é€šé“åˆ†ä¸ºä¸€ç»„
3. **å·®å¼‚åŒ–é‡åŒ–**: 
   - å†—ä½™ç»„ â†’ ä½æ¯”ç‰¹å…±äº«
   - ç‹¬ç«‹ç»„ â†’ é«˜æ¯”ç‰¹ä¿ç•™

### ç†è®ºä¼˜åŠ¿

```
ä¿¡æ¯è®ºåŸºç¡€:
I(X;Y) = H(X) + H(Y) - H(X,Y)

é«˜MI â†’ é«˜å†—ä½™ â†’ å¯å…±äº«ä½æ¯”ç‰¹ â†’ èŠ‚çœé¢„ç®—
ä½MI â†’ ä½å†—ä½™ â†’ éœ€ç‹¬ç«‹é«˜æ¯”ç‰¹ â†’ ä¿ç•™ä¿¡æ¯
```

---

## ğŸ’» æŠ€æœ¯å®ç°

### 1. äº’ä¿¡æ¯è®¡ç®— (`mutual_info.py`)

**å¿«é€Ÿæ–¹æ³•ï¼ˆç›¸å…³ç³»æ•°è¿‘ä¼¼ï¼‰**ï¼š
```python
MI â‰ˆ -0.5 * log(1 - corrÂ²)
```

**ç²¾ç¡®æ–¹æ³•ï¼ˆç›´æ–¹å›¾/KNNï¼‰**ï¼š
```python
MI = H(X) + H(Y) - H(X,Y)
```

**æˆå¯¹äº’ä¿¡æ¯çŸ©é˜µ**ï¼š
```python
MI_matrix = compute_mi_matrix_fast(activations)
# è¾“å‡º: [N_channels Ã— N_channels]
```

### 2. é€šé“åˆ†ç»„ (`channel_grouping.py`)

**èšç±»æ–¹æ³•**ï¼š
- è°±èšç±»ï¼ˆSpectral Clusteringï¼‰- é»˜è®¤
- å±‚æ¬¡èšç±»ï¼ˆHierarchical Clusteringï¼‰
- K-meansèšç±»

**è‡ªåŠ¨é€‰æ‹©åˆ†ç»„æ•°**ï¼š
```python
best_K = auto_select_n_groups(
    MI_matrix,
    criterion='silhouette'
)
```

**æ¯”ç‰¹åˆ†é…ç­–ç•¥**ï¼š
```python
# åŸºäºç»„é‡è¦æ€§åˆ†é…æ¯”ç‰¹
é‡è¦ç»„ï¼ˆavg_imp > 0.15ï¼‰ â†’ 8 bits
ä¸­ç­‰ç»„ï¼ˆ0.05-0.15ï¼‰      â†’ 4-6 bits
æ¬¡è¦ç»„ï¼ˆ< 0.05ï¼‰         â†’ 2-3 bits
```

### 3. MIé‡åŒ–SparseGPT (`sparsegpt_mi.py`)

**æ ¸å¿ƒæµç¨‹**ï¼š
```python
1. add_batch(): æ”¶é›†æ¿€æ´» + ä¿å­˜å†å²
   â†“
2. compute_mi_grouping(): è®¡ç®—MIçŸ©é˜µ + åˆ†ç»„
   â†“
3. allocate_group_bits(): ä¸ºç»„åˆ†é…æ¯”ç‰¹
   â†“
4. fasterprune(): å‰ªæ + åˆ†ç»„é‡åŒ–
   â†“
5. è¾“å‡º: å‹ç¼©æ¨¡å‹ + ç»Ÿè®¡ä¿¡æ¯
```

**ä¸åŸç‰ˆçš„å·®å¼‚**ï¼š
- âœ… ä¿ç•™: Hessianå‰ªæ
- âœ… ä¿ç•™: è¯¯å·®è¡¥å¿æœºåˆ¶
- ğŸ†• æ–°å¢: MIçŸ©é˜µè®¡ç®—
- ğŸ†• æ–°å¢: é€šé“åˆ†ç»„
- ğŸ†• æ–°å¢: ç»„å†…é‡åŒ–

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿæµ‹è¯•

```bash
cd /media/user/data3/toky/Projects/SparseGPT/mutual_info_quantization
chmod +x test_mi.sh
./test_mi.sh
```

è¿™ä¼šè‡ªåŠ¨è¿è¡Œ3ä¸ªæµ‹è¯•ï¼š
1. åŸç‰ˆSparseGPTï¼ˆåŸºå‡†ï¼‰
2. å¢å¼ºç‰ˆï¼ˆæ— MIåˆ†ç»„ï¼‰
3. MIæ”¹è¿›ç‰ˆï¼ˆæœ¬æ–¹æ¡ˆï¼‰

### è‡ªå®šä¹‰æµ‹è¯•

```bash
# ä½¿ç”¨MIåˆ†ç»„
python opt_mi.py facebook/opt-125m c4 \
    --sparsity 0.5 \
    --wbits 4 \
    --target_avg_bits 4.0 \
    --use_mi_grouping 1 \
    --n_groups 10

# ä¸ä½¿ç”¨MIåˆ†ç»„ï¼ˆå¯¹æ¯”åŸºå‡†ï¼‰
python opt_mi.py facebook/opt-125m c4 \
    --sparsity 0.5 \
    --wbits 4 \
    --target_avg_bits 4.0 \
    --use_mi_grouping 0
```

### å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--use_mi_grouping` | æ˜¯å¦ä½¿ç”¨MIåˆ†ç»„ (0/1) | 1 |
| `--n_groups` | åˆ†ç»„æ•°é‡ | 10 |
| `--target_avg_bits` | ç›®æ ‡å¹³å‡æ¯”ç‰¹æ•° | 4.0 |
| `--sparsity` | ç¨€ç–åº¦ | 0.5 |
| `--wbits` | åŸºç¡€é‡åŒ–æ¯”ç‰¹ | 4 |

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### æ€§èƒ½é¢„æµ‹

åŸºäºå½“å‰å¢å¼ºç‰ˆçš„ç»“æœï¼ˆsp=0.5, 4bit avgï¼‰ï¼š

| æ–¹æ³• | WikiText2 PPL | æ”¹è¿› |
|------|---------------|------|
| åŸç‰ˆ | 39.109 | åŸºå‡† |
| å¢å¼ºç‰ˆï¼ˆæ— MIï¼‰ | 36.186 | -7.5% |
| MIæ”¹è¿›ç‰ˆï¼ˆä¿å®ˆï¼‰ | ~35.0 | -10.5% |
| MIæ”¹è¿›ç‰ˆï¼ˆä¹è§‚ï¼‰ | ~34.0 | -13.0% |

### å…³é”®ä¼˜åŠ¿

1. **å‘ç°å†—ä½™**ï¼š
   - é‡åŒ–é€šé“é—´çš„ä¾èµ–å…³ç³»
   - è¯†åˆ«é«˜åº¦ç›¸å…³çš„é€šé“ç»„

2. **åˆ©ç”¨å†—ä½™**ï¼š
   - ç›¸å…³é€šé“å…±äº«ä½æ¯”ç‰¹
   - èŠ‚çœçš„é¢„ç®—åˆ†é…ç»™å…³é”®é€šé“

3. **ç†è®ºä¿è¯**ï¼š
   - åŸºäºä¿¡æ¯è®ºçš„æ¯”ç‰¹åˆ†é…
   - æœ€å°åŒ–äº’ä¿¡æ¯æŸå¤±

---

## ğŸ”¬ å®éªŒè®¡åˆ’

### Phase 1: æ¦‚å¿µéªŒè¯ï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**: éªŒè¯MIåˆ†ç»„çš„åŸºæœ¬æœ‰æ•ˆæ€§

**å®éªŒ**:
- [ ] å•å±‚MIçŸ©é˜µå¯è§†åŒ–
- [ ] åˆ†ç»„è´¨é‡è¯„ä¼°ï¼ˆSilhouette Scoreï¼‰
- [ ] å¯¹æ¯”åˆ†ç»„vsç‹¬ç«‹é‡åŒ–

### Phase 2: ç³»ç»Ÿé›†æˆï¼ˆ3-5å¤©ï¼‰

**ç›®æ ‡**: å®Œæ•´å®ç°å¹¶è°ƒä¼˜

**å®éªŒ**:
- [ ] ä¸åŒKå€¼æµ‹è¯•ï¼ˆ5, 10, 20, 50ï¼‰
- [ ] ä¸åŒMIæ–¹æ³•å¯¹æ¯”ï¼ˆç›¸å…³ç³»æ•° vs KNNï¼‰
- [ ] ä¸åŒç¨€ç–åº¦æµ‹è¯•ï¼ˆ0.3, 0.5, 0.7ï¼‰

### Phase 3: å…¨é¢è¯„ä¼°ï¼ˆ1-2å‘¨ï¼‰

**ç›®æ ‡**: è®ºæ–‡çº§å®éªŒ

**å®éªŒ**:
- [ ] å¤šæ¨¡å‹æµ‹è¯•ï¼ˆOPT-125m/350m/1.3bï¼‰
- [ ] æ¶ˆèå®éªŒï¼ˆå»é™¤MI vs å»é™¤åˆ†ç»„ï¼‰
- [ ] ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒï¼ˆT-testï¼‰

---

## ğŸ“ˆ è¯„ä¼°æŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡

1. **PPLï¼ˆå›°æƒ‘åº¦ï¼‰**ï¼š
   - WikiText2
   - PTB
   - C4

2. **å‹ç¼©ç‡**ï¼š
   - å®é™…å¹³å‡æ¯”ç‰¹æ•°
   - æ¨¡å‹å¤§å°

### æ•ˆç‡æŒ‡æ ‡

1. **è®¡ç®—å¼€é”€**ï¼š
   - MIçŸ©é˜µè®¡ç®—æ—¶é—´
   - æ€»è¿è¡Œæ—¶é—´

2. **å†…å­˜å ç”¨**ï¼š
   - å³°å€¼GPUå†…å­˜
   - æ¿€æ´»å†å²å­˜å‚¨

### åˆ†ç»„è´¨é‡

1. **èšç±»è´¨é‡**ï¼š
   - Silhouette Score
   - Davies-Bouldin Index

2. **å¯è§£é‡Šæ€§**ï¼š
   - MIçŸ©é˜µå¯è§†åŒ–
   - åˆ†ç»„ç»“æ„åˆ†æ

---

## ğŸ’¡ åˆ›æ–°ç‚¹æ€»ç»“

### å­¦æœ¯è´¡çŒ®

1. **ç†è®ºåˆ›æ–°**ï¼š
   - å°†äº’ä¿¡æ¯ç†è®ºå¼•å…¥SparseGPT
   - å»ºç«‹ä¿¡æ¯è®ºä¸æ¨¡å‹å‹ç¼©çš„æ¡¥æ¢

2. **æ–¹æ³•åˆ›æ–°**ï¼š
   - å¤šç²’åº¦é‡åŒ–ï¼ˆé€šé“çº§+ç»„çº§ï¼‰
   - è‡ªé€‚åº”åˆ†ç»„ç­–ç•¥

3. **å·¥ç¨‹åˆ›æ–°**ï¼š
   - é«˜æ•ˆMIè®¡ç®—æ–¹æ³•
   - å¯æ‰©å±•çš„åˆ†ç»„æ¡†æ¶

### å®ç”¨ä»·å€¼

1. **éƒ¨ç½²åœºæ™¯**ï¼š
   - è¾¹ç¼˜è®¾å¤‡æ¨ç†
   - ç§»åŠ¨ç«¯åº”ç”¨
   - äº‘ç«¯æœåŠ¡ä¼˜åŒ–

2. **æ‰©å±•æ–¹å‘**ï¼š
   - ä¸çŸ¥è¯†è’¸é¦ç»“åˆ
   - ä¸ç»“æ„åŒ–å‰ªæç»“åˆ
   - æ¨å¹¿åˆ°å…¶ä»–æ¨¡å‹æ¶æ„

---

## âœ… å¯è¡Œæ€§è¯„ä¼°

### æ€»ä½“è¯„åˆ†ï¼š**9/10** â­â­â­â­â­

**ä¼˜åŠ¿**ï¼š
- âœ… ç†è®ºåŸºç¡€æ‰å®ï¼ˆä¿¡æ¯è®ºï¼‰
- âœ… æŠ€æœ¯è·¯çº¿æ¸…æ™°ï¼ˆå·²å®ç°ï¼‰
- âœ… é¢„æœŸæ”¶ç›Šæ˜æ˜¾ï¼ˆ3-7%æå‡ï¼‰
- âœ… å®ç°å¤æ‚åº¦å¯æ§

**æŒ‘æˆ˜**ï¼š
- âš ï¸ MIè®¡ç®—å¼€é”€ï¼ˆå·²ä¼˜åŒ–ï¼‰
- âš ï¸ è¶…å‚æ•°è°ƒä¼˜ï¼ˆè‡ªåŠ¨åŒ–ï¼‰
- âš ï¸ å¤§æ¨¡å‹é€‚é…ï¼ˆå¯æ‰©å±•ï¼‰

### æ¨èåº¦ï¼š**å¼ºçƒˆæ¨èï¼**

è¿™æ˜¯ä¸€ä¸ª**éå¸¸é è°±**ä¸”**æœ‰å­¦æœ¯ä»·å€¼**çš„æ”¹è¿›æ–¹å‘ï¼š
1. ç†è®ºæ‰å®
2. å®ç°å¯è¡Œ
3. æ•ˆæœå¯æœŸ
4. å¯å‘è®ºæ–‡

---

## ğŸ“š å‚è€ƒèµ„æº

### ä»£ç æ–‡ä»¶

1. `mutual_info.py` - MIè®¡ç®—ï¼ˆ200è¡Œï¼‰
2. `channel_grouping.py` - åˆ†ç»„ç®—æ³•ï¼ˆ250è¡Œï¼‰
3. `sparsegpt_mi.py` - æ ¸å¿ƒå®ç°ï¼ˆ350è¡Œï¼‰
4. `opt_mi.py` - æµ‹è¯•è„šæœ¬ï¼ˆ300è¡Œï¼‰

### æ–‡æ¡£

1. `README.md` - é¡¹ç›®è¯´æ˜
2. `æ”¹è¿›æ–¹æ¡ˆè¯„ä¼°.md` - è¯¦ç»†è¯„ä¼°ï¼ˆâ­æ¨èï¼‰
3. `é¡¹ç›®æ€»ç»“.md` - æœ¬æ–‡æ¡£

### æµ‹è¯•è„šæœ¬

1. `test_mi.sh` - å¿«é€Ÿæµ‹è¯•
2. æ›´å¤šè„šæœ¬å¾…å¼€å‘...

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨

1. **è¿è¡Œæµ‹è¯•**ï¼š
   ```bash
   ./test_mi.sh
   ```

2. **æŸ¥çœ‹ç»“æœ**ï¼š
   ```bash
   cat test_results/*.log
   ```

3. **åˆ†æMIçŸ©é˜µ**ï¼š
   - å¯è§†åŒ–åˆ†ç»„ç»“æ„
   - è¯„ä¼°åˆ†ç»„è´¨é‡

### çŸ­æœŸç›®æ ‡ï¼ˆ1å‘¨ï¼‰

1. æ¦‚å¿µéªŒè¯å®éªŒ
2. å‚æ•°è°ƒä¼˜
3. æ€§èƒ½å¯¹æ¯”

### é•¿æœŸç›®æ ‡ï¼ˆ1æœˆï¼‰

1. å¤šæ¨¡å‹éªŒè¯
2. æ’°å†™è®ºæ–‡
3. å¼€æºå‘å¸ƒ

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-13  
**ç‰ˆæœ¬**: 1.0  
**ä½œè€…**: Toky  
**åŸºäº**: enhanced_fix_acc_version

---

**ç¥å®éªŒé¡ºåˆ©ï¼æœŸå¾…çœ‹åˆ°ä»¤äººæŒ¯å¥‹çš„ç»“æœï¼** ğŸš€

